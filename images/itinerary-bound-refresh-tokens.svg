<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1149" height="709"><desc>participant%20%22Client%22%20as%20client%0Aparticipant%20%22Authorization%20Server%20(AS)%22%20as%20AS%0A%0Abottomparticipants%0A%0Anote%20over%20client%2CAS%3AHMAC(K1%2C%20m1)%0Anote%20right%20of%20client%3AClient%3A%5Cn%E2%80%A2%20is%20registered%20at%20the%20AS%20as%20a%20confidential%20client%20and%20has%20a%20client%20secret%5Cn%E2%80%A2%20client%20has%20a%20valid%20Refresh%20Token%20issued%20by%20the%20AS%0Anote%20right%20of%20AS%3AAS%3A%5Cn%E2%80%A2%20issues%20opaque%20Refresh%20Tokens%20and%20Access%20Tokens%20using%20high%20entropy%20nonce%20data%20strings%0Aclient-%3Eclient%3A1.%20Client%3A%5Cn%E2%80%A2%20generates%20the%20Route-JWT%20with%20a%20payload%20including%20the%20Refresh%20Token%20and%20a%20timestamp%20%0Anote%20right%20of%20client%3AThe%20Route-JWT%20is%20generated%20as%3A%5CnRoute-JWT%20%3D%20header%20%7C%7C%20%22.%22%20%7C%7C%20payload%20%7C%7C%20%22.%22%20%7C%7C%20signature%5Cnwhere%5Cnheader%20%3D%20base64url(%7B%22typ%22%3A%22JWT%22%2C%22alg%22%3A%22HS256%22%7D)%5Cnpayload%20%3D%20base64url(%7B%22token%22%3ARefresh%20Token%2C%22ts%22%3Atimestamp%7D)%5Cnsignature%20%3D%20base64url(HMAC-SHA256(K1%2C%20m1))%5Cnwhere%5Cnm1%20%3D%20header%20%7C%7C%20%22.%22%20%7C%7C%20payload%5CnK1%20%3D%20SHA256(client's%20client%20secret)%0Aclient-%3EAS%3A2.%20Route%20JWT%0Anote%20right%20of%20client%3AClient%20sends%20the%20destination%20Route-JWT%20in%20the%20Authorization%20header%5Cnto%20authenticate%20itself%20to%20the%20AS%20token%20endpoint%0AAS-%3EAS%3A3.%20AS%3A%5Cn%20a)%20looks%20up%20the%20Refresh%20Token%20data%20using%20the%20token%20claim%20value%20from%20the%20Route-JWT%2C%20and%20checks%20the%20token%20state%5Cn%20b)%20generates%20the%20Itinerary-JWT%20in%20an%20analogous%20manner%20as%20the%20Route-JWT%20using%20the%20payload%20from%20the%20Route-JWT%5Cn%20c)%20compares%20the%20Itinerary-JWT%20signature%20with%20the%20Route-JWT%20signature%2C%20they%20are%20equal%2C%5Cn%20%20%20%20%20the%20Refresh%20Token%20route%20and%20the%20Route-JWT%20have%20been%20verified%2C%5Cn%20%20%20%20%20the%20AS%20validates%20the%20ts%20(timestamp)%20claim%20value%20from%20the%20Route-JWT%2C%20if%20valid%2C%5Cn%20%20%20%20%20the%20AS%20may%20generate%20and%20return%20a%20new%20Refresh%20Token%20and%20a%20new%20Access%20Token%0Aclient%3C-AS%3A4.%20Refresh%20Token%20and%20Access%20Token%0A</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="1149" height="709"/></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 38.111285853 L 33.37474404576514 669.152754873" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray="8.699220692307692,3.7696623000000002"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 38.111285853 L 527.6245492934214 669.152754873" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray="8.699220692307692,3.7696623000000002"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 5.654493450000004 7.690111091999997 L 61.09499464153028 7.690111091999997 L 61.09499464153028 38.111285853 L 5.654493450000004 38.111285853 L 5.654493450000004 7.690111091999997 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="17.924744236500004" y="26.802298953" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 447.52096263045655 7.690111091999997 L 607.7281359563863 7.690111091999997 L 607.7281359563863 38.111285853 L 447.52096263045655 38.111285853 L 447.52096263045655 7.690111091999997 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="459.79121341695657" y="26.802298953" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Authorization Server (AS)</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 5.654493450000004 669.152754873 L 61.09499464153028 669.152754873 L 61.09499464153028 699.573929634 L 5.654493450000004 699.573929634 L 5.654493450000004 669.152754873 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="17.924744236500004" y="688.2649427340001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 447.52096263045655 669.152754873 L 607.7281359563863 669.152754873 L 607.7281359563863 699.573929634 L 447.52096263045655 699.573929634 L 447.52096263045655 669.152754873 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="459.79121341695657" y="688.2649427340001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Authorization Server (AS)</text></g></g><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 23.196655835765142 60.729259653 L 527.6245492934213 60.729259653 L 537.8026375034214 70.907347863 L 537.8026375034214 86.739929523 L 23.196655835765142 86.739929523 L 23.196655835765142 60.729259653 M 527.6245492934213 60.729259653 L 527.6245492934213 70.907347863 L 537.8026375034214 70.907347863" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="241.55798102017923" y="76.561841313" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">HMAC(K1, m1)</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 128.01773170799999 L 39.029237495765145 128.01773170799999 M 39.029237495765145 103.703409873 L 437.7663126057651 103.703409873 L 447.9444008157651 113.881498083 L 447.9444008157651 152.332053543 L 39.029237495765145 152.332053543 L 39.029237495765145 103.703409873 M 437.7663126057651 103.703409873 L 437.7663126057651 113.881498083 L 447.9444008157651 113.881498083" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="119.53599153299999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="130.844978433" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• is registered at the AS as a confidential client and has a client secret</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="142.153965333" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• client has a valid Refresh Token issued by the AS</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 187.95536227800002 L 533.2790427434214 187.95536227800002 M 533.2790427434214 169.29553389300003 L 1033.0827987616246 169.29553389300003 L 1043.2608869716246 179.47362210300003 L 1043.2608869716246 206.61519066300002 L 533.2790427434214 206.61519066300002 L 533.2790427434214 169.29553389300003 M 1033.0827987616246 169.29553389300003 L 1033.0827987616246 179.47362210300003 L 1043.2608869716246 179.47362210300003" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="549.1116244034214" y="185.12811555300001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AS:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="549.1116244034214" y="196.43710245300002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• issues opaque Refresh Tokens and Access Tokens using high entropy nonce data strings</text></g><g><g><rect fill="white" stroke="none" x="46.75704521076514" y="223.57867101300002" width="51.47602813176758" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="46.75704521076514" y="234.88765791300003" width="476.90935866765625" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="48.45339324576514" y="233.75675922300002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. Client:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="48.45339324576514" y="245.06574612300003" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• generates the Route-JWT with a payload including the Refresh Token and a timestamp </text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 249.589340883 L 78.61069164576514 249.589340883 L 78.61069164576514 264.291023853 L 42.685809926765145 264.291023853" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(33.37474404576514,264.291023853) translate(-33.37474404576514,-264.291023853)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 42.79889979576514 259.57894597800004 L 33.37474404576514 264.291023853 L 42.79889979576514 269.003101728 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 339.495786738 L 39.029237495765145 339.495786738 M 39.029237495765145 281.254504203 L 395.199631697562 281.254504203 L 405.377719907562 291.432592413 L 405.377719907562 397.73706927300003 L 39.029237495765145 397.73706927300003 L 39.029237495765145 281.254504203 M 395.199631697562 281.254504203 L 395.199631697562 291.432592413 L 405.377719907562 291.432592413" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="297.08708586299997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">The Route-JWT is generated as:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="308.39607276299995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Route-JWT = header || "." || payload || "." || signature</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="319.70505966299993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">where</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="331.0140465629999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">header = base64url({"typ":"JWT","alg":"HS256"})</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="342.3230334629999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">payload = base64url({"token":Refresh Token,"ts":timestamp})</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="353.63202036299987" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">signature = base64url(HMAC-SHA256(K1, m1))</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="364.94100726299985" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">where</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="376.2499941629998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">m1 = header || "." || payload</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="387.5589810629998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">K1 = SHA256(client's client secret)</text></g><g><g><rect fill="white" stroke="none" x="244.71163145930032" y="414.70054962300003" width="71.57603042058594" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="246.40797949430032" y="424.878637833" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. Route JWT</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 429.402232593 L 518.3134834124214 429.402232593" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(527.6245492934214,429.402232593) translate(-527.6245492934214,-429.402232593)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 518.2003935434215 424.69015471800003 L 527.6245492934214 429.402232593 L 518.2003935434215 434.114310468 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 465.025541328 L 39.029237495765145 465.025541328 M 39.029237495765145 446.365712943 L 419.132981306937 446.365712943 L 429.311069516937 456.543801153 L 429.311069516937 483.685369713 L 39.029237495765145 483.685369713 L 39.029237495765145 446.365712943 M 419.132981306937 446.365712943 L 419.132981306937 456.543801153 L 429.311069516937 456.543801153" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="462.19829460299997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client sends the destination Route-JWT in the Authorization header</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="473.50728150299994" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">to authenticate itself to the AS token endpoint</text></g><g><g><rect fill="white" stroke="none" x="541.0068504584214" y="500.648850063" width="34.64269607" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="511.957836963" width="602.3760334723438" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="523.266823863" width="604.7260090582813" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="534.575810763" width="467.69268386296875" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="545.8847976630001" width="357.14269607" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="557.1937845630001" width="429.2926899664844" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="568.5027714630002" width="438.7093769782031" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="510.826938273" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3. AS:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="522.135925173" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> a) looks up the Refresh Token data using the token claim value from the Route-JWT, and checks the token state</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="533.4449120730001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> b) generates the Itinerary-JWT in an analogous manner as the Route-JWT using the payload from the Route-JWT</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="544.7538989730001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> c) compares the Itinerary-JWT signature with the Route-JWT signature, they are equal,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="556.0628858730001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     the Refresh Token route and the Route-JWT have been verified,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="567.3718727730002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     the AS validates the ts (timestamp) claim value from the Route-JWT, if valid,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="578.6808596730002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     the AS may generate and return a new Refresh Token and a new Access Token</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 583.204454433 L 572.8604968934214 583.204454433 L 572.8604968934214 597.906137403 L 536.9356151744214 597.906137403" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(527.6245492934214,597.906137403) translate(-527.6245492934214,-597.906137403)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 537.0487050434214 593.194059528 L 527.6245492934214 597.906137403 L 537.0487050434214 602.618215278 Z"/></g></g><g><g><rect fill="white" stroke="none" x="186.38663451105813" y="614.869617753" width="188.2260243170703" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="188.08298254605813" y="625.0477059630001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">4. Refresh Token and Access Token</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 629.571300723 L 42.685809926765145 629.571300723" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(33.37474404576514,629.571300723) translate(-33.37474404576514,-629.571300723)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 42.79889979576514 624.8592228480001 L 33.37474404576514 629.571300723 L 42.79889979576514 634.283378598 Z"/></g></g></g></g></svg>