<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1149" height="666"><desc>participant%20%22Client%22%20as%20client%0Aparticipant%20%22Authorization%20Server%20(AS)%22%20as%20AS%0A%0Abottomparticipants%0A%0Anote%20right%20of%20client%3AClient%3A%5Cn%E2%80%A2%20is%20registered%20at%20the%20AS%20as%20a%20confidential%20client%20and%20has%20a%20client%20secret%5Cn%E2%80%A2%20client%20has%20a%20valid%20Refresh%20Token%20issued%20by%20the%20AS%0Anote%20right%20of%20AS%3AAS%3A%5Cn%E2%80%A2%20issues%20opaque%20Refresh%20Tokens%20and%20Access%20Tokens%20using%20high%20entropy%20nonce%20data%20strings%0Aclient-%3Eclient%3A1.%20Client%3A%5Cn%E2%80%A2%20generates%20the%20Route-JWT%20with%20a%20payload%20including%20the%20Refresh%20Token%20and%20a%20timestamp%20%0Anote%20right%20of%20client%3AThe%20Route-JWT%20is%20generated%20as%3A%5CnRoute-JWT%20%3D%20header%20%7C%7C%20%22.%22%20%7C%7C%20payload%20%7C%7C%20%22.%22%20%7C%7C%20signature%5Cnwhere%5Cnheader%20%3D%20base64url(%7B%22typ%22%3A%22JWT%22%2C%22alg%22%3A%22HS256%22%7D)%5Cnpayload%20%3D%20base64url(%7B%22token%22%3ARefresh%20Token%2C%22ts%22%3Atimestamp%7D)%5Cnsignature%20%3D%20base64url(HMAC-SHA256(Key%2C%20message))%5Cnwhere%5Cnmessage%20%3D%20header%20%7C%7C%20%22.%22%20%7C%7C%20payload%5CnKey%20%3D%20SHA256(client's%20client%20secret)%0Aclient-%3EAS%3A2.%20Route%20JWT%0Anote%20right%20of%20client%3AClient%20sends%20the%20destination%20Route-JWT%20in%20the%20Authorization%20header%5Cnto%20authenticate%20itself%20to%20the%20AS%20token%20endpoint%0AAS-%3EAS%3A3.%20AS%3A%5Cn%20a)%20looks%20up%20the%20Refresh%20Token%20data%20using%20the%20token%20claim%20value%20from%20the%20Route-JWT%2C%20and%20checks%20the%20token%20state%5Cn%20b)%20generates%20the%20Itinerary-JWT%20in%20an%20analogous%20manner%20as%20the%20Route-JWT%20using%20the%20payload%20from%20the%20Route-JWT%5Cn%20c)%20compares%20the%20Itinerary-JWT%20signature%20with%20the%20Route-JWT%20signature%2C%20they%20are%20equal%2C%5Cn%20%20%20%20%20the%20Refresh%20Token%20route%20and%20the%20Route-JWT%20have%20been%20verified%2C%5Cn%20%20%20%20%20the%20AS%20validates%20the%20ts%20(timestamp)%20claim%20value%20from%20the%20Route-JWT%2C%20if%20valid%2C%5Cn%20%20%20%20%20the%20AS%20may%20generate%20and%20return%20a%20new%20Refresh%20Token%20and%20a%20new%20Access%20Token%0Aclient%3C-AS%3A4.%20Refresh%20Token%20and%20Access%20Token%0A</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="1149" height="666"/></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 38.111285853 L 33.37474404576514 626.1786046530001" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray="8.699220692307692,3.7696623000000002"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 38.111285853 L 527.6245492934214 626.1786046530001" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray="8.699220692307692,3.7696623000000002"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 5.654493450000004 7.690111091999997 L 61.09499464153028 7.690111091999997 L 61.09499464153028 38.111285853 L 5.654493450000004 38.111285853 L 5.654493450000004 7.690111091999997 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="17.924744236500004" y="26.802298953" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 447.52096263045655 7.690111091999997 L 607.7281359563863 7.690111091999997 L 607.7281359563863 38.111285853 L 447.52096263045655 38.111285853 L 447.52096263045655 7.690111091999997 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="459.79121341695657" y="26.802298953" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Authorization Server (AS)</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 5.654493450000004 626.1786046530001 L 61.09499464153028 626.1786046530001 L 61.09499464153028 656.5997794140001 L 5.654493450000004 656.5997794140001 L 5.654493450000004 626.1786046530001 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="17.924744236500004" y="645.2907925140001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 447.52096263045655 626.1786046530001 L 607.7281359563863 626.1786046530001 L 607.7281359563863 656.5997794140001 L 447.52096263045655 656.5997794140001 L 447.52096263045655 626.1786046530001 Z" stroke-miterlimit="10" stroke-width="1.8094379040000002" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="459.79121341695657" y="645.2907925140001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Authorization Server (AS)</text></g></g><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 85.043581488 L 39.029237495765145 85.043581488 M 39.029237495765145 60.729259653 L 437.7663126057651 60.729259653 L 447.9444008157651 70.907347863 L 447.9444008157651 109.357903323 L 39.029237495765145 109.357903323 L 39.029237495765145 60.729259653 M 437.7663126057651 60.729259653 L 437.7663126057651 70.907347863 L 447.9444008157651 70.907347863" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="76.561841313" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="87.87082821300001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• is registered at the AS as a confidential client and has a client secret</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="99.17981511300002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• client has a valid Refresh Token issued by the AS</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 144.981212058 L 533.2790427434214 144.981212058 M 533.2790427434214 126.32138367300001 L 1033.0827987616246 126.32138367300001 L 1043.2608869716246 136.499471883 L 1043.2608869716246 163.641040443 L 533.2790427434214 163.641040443 L 533.2790427434214 126.32138367300001 M 1033.0827987616246 126.32138367300001 L 1033.0827987616246 136.499471883 L 1043.2608869716246 136.499471883" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="549.1116244034214" y="142.153965333" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AS:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="549.1116244034214" y="153.462952233" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• issues opaque Refresh Tokens and Access Tokens using high entropy nonce data strings</text></g><g><g><rect fill="white" stroke="none" x="46.75704521076514" y="180.604520793" width="51.47602813176758" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="46.75704521076514" y="191.913507693" width="476.90935866765625" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="48.45339324576514" y="190.782609003" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. Client:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="48.45339324576514" y="202.091595903" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">• generates the Route-JWT with a payload including the Refresh Token and a timestamp </text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 206.615190663 L 78.61069164576514 206.615190663 L 78.61069164576514 221.316873633 L 42.685809926765145 221.316873633" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(33.37474404576514,221.316873633) translate(-33.37474404576514,-221.316873633)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 42.79889979576514 216.604795758 L 33.37474404576514 221.316873633 L 42.79889979576514 226.028951508 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 296.52163651800004 L 39.029237495765145 296.52163651800004 M 39.029237495765145 238.280353983 L 395.199631697562 238.280353983 L 405.377719907562 248.458442193 L 405.377719907562 354.762919053 L 39.029237495765145 354.762919053 L 39.029237495765145 238.280353983 M 395.199631697562 238.280353983 L 395.199631697562 248.458442193 L 405.377719907562 248.458442193" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="254.11293564300001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">The Route-JWT is generated as:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="265.421922543" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Route-JWT = header || "." || payload || "." || signature</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="276.730909443" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">where</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="288.03989634299995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">header = base64url({"typ":"JWT","alg":"HS256"})</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="299.34888324299993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">payload = base64url({"token":Refresh Token,"ts":timestamp})</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="310.6578701429999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">signature = base64url(HMAC-SHA256(Key, message))</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="321.9668570429999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">where</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="333.27584394299987" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">message = header || "." || payload</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="344.58483084299985" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Key = SHA256(client's client secret)</text></g><g><g><rect fill="white" stroke="none" x="244.71163145930032" y="371.726399403" width="71.57603042058594" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="246.40797949430032" y="381.904487613" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. Route JWT</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 386.428082373 L 518.3134834124214 386.428082373" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(527.6245492934214,386.428082373) translate(-527.6245492934214,-386.428082373)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 518.2003935434215 381.716004498 L 527.6245492934214 386.428082373 L 518.2003935434215 391.140160248 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 33.37474404576514 422.05139110799996 L 39.029237495765145 422.05139110799996 M 39.029237495765145 403.391562723 L 419.132981306937 403.391562723 L 429.311069516937 413.569650933 L 429.311069516937 440.711219493 L 39.029237495765145 440.711219493 L 39.029237495765145 403.391562723 M 419.132981306937 403.391562723 L 419.132981306937 413.569650933 L 429.311069516937 413.569650933" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="419.22414438299995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Client sends the destination Route-JWT in the Authorization header</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="54.86181915576512" y="430.53313128299993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">to authenticate itself to the AS token endpoint</text></g><g><g><rect fill="white" stroke="none" x="541.0068504584214" y="457.67469984300004" width="34.64269607" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="468.983686743" width="602.3760334723438" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="480.292673643" width="604.7260090582813" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="491.601660543" width="467.69268386296875" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="502.91064744299996" width="357.14269607" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="514.2196343429999" width="429.2926899664844" height="14.70168297"/></g><g><rect fill="white" stroke="none" x="541.0068504584214" y="525.528621243" width="438.7093769782031" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="467.85278805300004" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3. AS:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="479.161774953" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> a) looks up the Refresh Token data using the token claim value from the Route-JWT, and checks the token state</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="490.470761853" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> b) generates the Itinerary-JWT in an analogous manner as the Route-JWT using the payload from the Route-JWT</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="501.779748753" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> c) compares the Itinerary-JWT signature with the Route-JWT signature, they are equal,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="513.088735653" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     the Refresh Token route and the Route-JWT have been verified,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="524.397722553" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     the AS validates the ts (timestamp) claim value from the Route-JWT, if valid,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="542.7031984934214" y="535.706709453" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     the AS may generate and return a new Refresh Token and a new Access Token</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 540.2303042130001 L 572.8604968934214 540.2303042130001 L 572.8604968934214 554.931987183 L 536.9356151744214 554.931987183" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(527.6245492934214,554.931987183) translate(-527.6245492934214,-554.931987183)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 537.0487050434214 550.2199093080001 L 527.6245492934214 554.931987183 L 537.0487050434214 559.644065058 Z"/></g></g><g><g><rect fill="white" stroke="none" x="186.38663451105813" y="571.8954675330001" width="188.2260243170703" height="14.70168297"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="8pt" font-style="normal" font-weight="normal" text-decoration="normal" x="188.08298254605813" y="582.0735557430002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">4. Refresh Token and Access Token</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 527.6245492934214 586.5971505030001 L 42.685809926765145 586.5971505030001" stroke-miterlimit="10" stroke-width="0.9424155750000001" stroke-dasharray=""/><g transform="translate(33.37474404576514,586.5971505030001) translate(-33.37474404576514,-586.5971505030001)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 42.79889979576514 581.8850726280001 L 33.37474404576514 586.5971505030001 L 42.79889979576514 591.3092283780001 Z"/></g></g></g></g></svg>