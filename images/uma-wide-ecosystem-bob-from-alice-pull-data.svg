<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2291" height="1831"><desc>Title%20UMA%20wide%20ecosystem%20-%20Bob%20from%20Alice%20(pull%20data)%0A%0Aactor%20%22Alice%20(RO)%5Cnalice%40gmail.com%2C%20alice%40foo.com%22%20as%20Alice%20%23lightpink%0Aparticipant%20%22AuthZ%20Server%5Cnfoo.com%22%20as%20asServer%20%23lightpink%0Aparticipant%20%22Resource%20Server%20(RS)%5Cnfoo.com%22%20as%20rsServer%20%23lightpink%0Aparticipant%20%22RqP%20Client%5Cnbar.com%22%20as%20rqpClient%20%23lightsteelblue%0Aparticipant%20%22Claims%20Provider%20(CP)%5Cnbar.com%22%20as%20claimsProvider%20%23lightsteelblue%0Aparticipant%20%22SMTP%20Server%5Cnoutlook.com%22%20as%20smtpServer%20%2300a2ed%0Aparticipant%20%22IMAP%20Server%5Cnoutlook.com%22%20as%20imapServer%20%2300a2ed%0Aparticipant%20%22AuthN%20Server%5Cnbar.com%22%20as%20authServer%20%23lightsteelblue%0Aactor%20%22Bob%20(RqP)%5Cnbob%40outlook.com%2C%20bob%40bar.com%22%20as%20Bob%20%23lightsteelblue%0A%0Abottomparticipants%0A%0Aopt%20Bob%20has%20to%20demonstrate%20control%20of%20his%20mailbox%0Anote%20left%20of%20Bob%3AIf%20Bob%20uses%20an%20email%20provider%20(outlook)%20that%20does%20not%20support%20webfinger%2C%5Cnhe%20must%20set%20up%20his%20mailbox%20to%20automatically%20forward%20emails%20sent%5Cnfrom%20challenge%40bar.com%20to%20response%40bar.com%0Aend%0Aopt%20Bob%20has%20to%20demonstrate%20control%20of%20his%20mailbox%0Abox%20over%20claimsProvider%3AClaims%20Provider%20can%20send%20email%20messages%20from%20addresses%20challenge%40bar.com%20and%20retrieve%20from%20response%40bar.com%0Aend%0Anote%20over%20rqpClient%3ARqP%20Client%20is%20registered%20at%20bar.com%20AuthN%20server%20and%20pre-registered%20as%20a%20universal%20AEMS%20public%20client%20at%20foo.com%20AuthZ%20server%0Anote%20over%20rsServer%3Afoo.com%20Admin%20has%20set%20up%20the%20Resource%20Server%20and%20registers%20it's%20resource%20set%5Cn'Incoming'%20and%20'Outgoing'%20with%20the%20foo.com%20AuthZ%20server%20with%20the%20associated%20scopes%3A%5Cn'Outgoing'%3A%20query%2C%20view%5Cn'Incoming'%3A%20create%0Anote%20over%20claimsProvider%3AClaims%20Provider%3A%5Cn1.%20publishes%20its%20metadata%20on%20a%20URL%20https%3A%2F%2Fbar.com%2F.well-known%2Fclaims-provider-configuration%5Cn2.%20is%20registered%20at%20Bob's%20AuthN%20server%20and%20is%20assigned%20'query-users'%2C%20'view-users'%20admin%20roles%0ArqpClient%3C-Bob%3AInitiate%20request%0ArsServer%3C-rqpClient%3A1.%20Request%20Alice's%20'Outgoing'%20resource%5Cn(scope%3Dquery%2C%20view)%0ArsServer-%3ErqpClient%3A2.%20401%20with%20permission%20ticket%0Aalt%20RqP%20Client%20uses%20Authorization%20Code%20Grant%20-%20Bob%20is%20involved%0ArqpClient-%3EauthServer%3A3.%20a)%20Get%20access_token%5Cn(grant_type%3Dauthorization_code%2C%20scope%3Dclaims-provider)%0Aelse%20RqP%20Client%20uses%20Client%20Credential%20Grant%20-%20Bob%20is%20not%20involved%0ArqpClient-%3EauthServer%3A3.%20b)%20Get%20access_token%5Cn(grant_type%3Dclient_credentials%2C%20scope%3Dclaims-provider)%0Aend%0ArqpClient%3C-authServer%3A4.%20Return%20access_token%20%22audience%22%3A%5B%22claims-provider%22%5D%0Anote%20right%20of%20rqpClient%3Aticket_challenge%20%3D%20Base64URL-Encode(SHA256(ticket))%0Aalt%20Get%20Claims%20%20-%20Bob%20was%20involved%20at%20step%20%203.%20a)%0Anote%20right%20of%20rqpClient%3ABob's%20email_address%20is%20in%20access_token%20%22audience%22%3A%5B%22claims-provider%22%5D%20returned%20in%20request%203.%20a)%20%2F%204.%0AclaimsProvider%3C-rqpClient%3A5.%20a)%20Get%20claims_token%5Cn(access_token%20%22audience%22%3A%5B%22claims-provider%22%5D%2C%20ticket_challenge)%0Aelse%20Get%20Claims%20-%20Bob%20was%20not%20involved%20at%20step%20%203.%20b)%0Anote%20right%20of%20rqpClient%3A%20The%20email_address%20is%20specified%20by%20RqP%20Client%0AclaimsProvider%3C-rqpClient%3A5.%20b)%20Get%20claims_token%5Cn(access_token%20%22audience%22%3A%5B%22claims-provider%22%5D%2C%20Bob's%20email_address%2C%20ticket_challenge)%0Aend%0Anote%20over%20claimsProvider%3AClaims%20Provider%20is%20assigned%20the%20'query-users%2C%20view-users'%20admin%20roles%2C%20thus%20can%20query%20and%20view%20any%20user%20to%20get%20their%20claims%0AclaimsProvider-%3EauthServer%3A6.%20Get%20access_token%5Cn(grant_type%3Dclient_credentials%2C%20role%3Dquery-users%2C%20view-users)%0AclaimsProvider%3C-authServer%3A7.%20Return%20access_token%20%22audience%22%3A%5B%22realm-management%22%5D%0A%0Aalt%20Prepare%20email_address%20-%20Bob%20was%20involved%20at%20step%20%203.%20a)%0Anote%20over%20claimsProvider%3AUse%20Bob's%20email_address%20extracted%20from%20access_token%20%22audience%22%3A%5B%22claims-provider%22%5D%20from%20a%20request%20at%20step%205.%20a)%0Aelse%20Prepare%20email_address%20-%20Bob%20was%20not%20involved%20at%20step%20%203.%20b)%0Anote%20over%20claimsProvider%3AUse%20Bob's%20email_address%20extracted%20from%20a%20request%20body%20at%20step%205.%20b)%0Aend%0AauthServer%3C-claimsProvider%3A8.%20Query%2FView%20Bob's%20user_claims%5Cn(access_token%20%22audience%22%3A%5B%22realm-management%22%5D%2C%20Bob's%20email_address)%0AauthServer-%3EclaimsProvider%3A9.%20Return%20Bob's%20user_claims%0A%0Aopt%20Bob%20has%20to%20demonstrate%20control%20of%20his%20mailbox%0AsmtpServer%3C-claimsProvider%3A10.%20Send%20plain_message%20from%20challenge%40bar.com%20to%20bob%40outlook.com%5Cn(claims_provider_configuration_url%2C%20ticket_challenge)%0AimapServer-%3EclaimsProvider%3A11.%20Retrieve%20dkim_signed_message%20sent%20from%20bob%40outlook.com%20to%20response%40bar.com%5Cn(claims_provider_configuration_url%2C%20ticket_challenge)%0Aend%0ArqpClient%3C-claimsProvider%3A12.%20Return%20claims_token%5Cn(Bob's%20user_claims%2C%20dkim_signed_message%20-%20optional)%5Cnif%20the%20payload%20is%20large%2C%20consider%20using%20PCT%20(see%20UMA%20specs.%20for%20details)%0ArqpClient-%3EasServer%3A13.%20Call%20token%20endpoint%5Cn(ticket%2C%20pushed_claims%3Dclaims_token)%0Anote%20over%20asServer%3AIn%20addition%20to%20claims_token%2C%20pushed%20claims%20may%20also%20contain%20metadata%20such%20as%3A%5Cn1.%20recipient_info%20(email%20address%2C%20fullname)%5Cn2.%20file_info%20(filename%2C%20file%20size%2C%20file%20digest%2C%20mime%20type)%0Agroup%20Authorization%20process%0Aalt%20Domain%20part%20of%20email_address%20or%20Webfinger%20is%20used%20to%20locate%20Claims%20Provider%20configuration%20url%0Anote%20over%20asServer%3A1.%20extract%20user_claims%20from%20claims_token%5Cn2.%20select%20email_address%20claim%5Cn3.%20bootstrap%20discovery%20of%20Claims%20Provider%20config%20url%20via%20Webfinger%2C%20if%20it%20doesn't%20work%5Cnbuild%20well-known%20url%20using%20domain%20part%20of%20email_address%5Cn4.%20verify%20claims_token%20signature%20%5Cn5.%20extract%20ticket_challenge%20claim%20from%20claims_token%5Cn6.%20compare%20ticket_challenge%20vs.%20Base64URL-Encode(SHA256(ticket))%5Cn7.%20evaluate%20user_claims%5Cn8.%20evaluate%20other%20optional%20claims%20e.g.%20recipient_info%2C%20file_info%0Aelse%20Bob%20has%20to%20demonstrate%20control%20of%20his%20mailbox%0Anote%20over%20asServer%3A1.%20extract%20dkim_signed%20_message%20from%20claims_token%5Cn2.%20verify%20DKIM%20signature%20of%20dkim_signed%20_message%5Cn3.%20extract%20'From%3A'%20part%20of%20dkim_signed_message%20e.g.%20Bob%20Sanders%20%3Cbob%40outlook.com%3E%5Cn4.%20extract%20claims_provider_configuration_url%20and%20ticket_challenge%20from%20dkim_signed_message%5Cn5.%20verify%20claims_token%20signature%5Cn6.%20compare%20ticket_challenge%20vs.%20Base64URL-Encode(SHA256(ticket))%5Cn7.%20extract%20user_claims%20from%20claims_token%5Cn8.%20evaluate%20user_claims%5Cn9.%20evaluate%20other%20optional%20claims%20e.g.%20recipient_info%2C%20file_info%0Aend%0Aend%0ArqpClient%3C-asServer%3A14.%20Return%20RPT%0ArsServer%3C-rqpClient%3A15.%20Get%20data%20from%20Alice's%20'Outgoing'%20resource%5Cn(RPT)%0ArsServer-%3ErqpClient%3A16.%20200%20OK</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="2291" height="1831"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="10.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="993.6922728723675" y="13.19381805" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">UMA wide ecosystem - Bob from Alice (pull data)</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 73.48673024355469 78.15138224949999 L 73.48673024355469 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 301.4519883503125 78.15138224949999 L 301.4519883503125 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 529.4172464570703 78.15138224949999 L 529.4172464570703 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 78.15138224949999 L 807.4334321003515 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1248.3854200861329 78.15138224949999 L 1248.3854200861329 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1569.2391068733725 78.15138224949999 L 1569.2391068733725 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1761.4557909652344 78.15138224949999 L 1761.4557909652344 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1880.573990563446 78.15138224949999 L 1880.573990563446 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 2217.8374822492274 78.15138224949999 L 2217.8374822492274 1773.9967956094983" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray="6.766060538461538,2.9319595666666665"/></g><g><g><path fill="lightpink" stroke="black" paint-order="fill stroke markers" d=" M 78.50038110255468 32.1489366485 A 5.013650858999999 5.013650858999999 0 1 1 78.50037859572947 32.143922998476604 M 73.48673024355469 37.16258750749999 L 73.48673024355469 47.893559521499995 M 67.15369757955469 41.03277413549999 L 79.81976290755469 41.03277413549999 M 73.48673024355469 47.893559521499995 L 67.15369757955469 57.92086123949999 M 73.48673024355469 47.893559521499995 L 79.81976290755469 57.92086123949999" stroke-miterlimit="10" stroke-width="1.495299379" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="51.97918477236328" y="66.71673993949999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Alice (RO)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="4.3979393500000015" y="75.51261863949999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alice@gmail.com, alice@foo.com</text></g><path fill="none" stroke="none"/><g><path fill="lightpink" stroke="black" paint-order="fill stroke markers" d=" M 264.43191271960154 45.694589846499994 L 338.47206398102344 45.694589846499994 L 338.47206398102344 78.15138224949999 L 264.43191271960154 78.15138224949999 L 264.43191271960154 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="273.97544110910155" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AuthZ Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="284.8612977375195" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">foo.com</text></g><path fill="none" stroke="none"/><g><path fill="lightpink" stroke="black" paint-order="fill stroke markers" d=" M 473.9982526745039 45.694589846499994 L 584.8362402396367 45.694589846499994 L 584.8362402396367 78.15138224949999 L 473.9982526745039 78.15138224949999 L 473.9982526745039 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="483.5417810640039" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Resource Server (RS)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="512.8265558442773" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">foo.com</text></g><path fill="none" stroke="none"/><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 775.5966526732539 45.694589846499994 L 839.2702115274492 45.694589846499994 L 839.2702115274492 78.15138224949999 L 775.5966526732539 78.15138224949999 L 775.5966526732539 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="785.1401810627539" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">RqP Client</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="790.8428025227148" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com</text></g><path fill="none" stroke="none"/><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 1195.045665195168 45.694589846499994 L 1301.7251749770978 45.694589846499994 L 1301.7251749770978 78.15138224949999 L 1195.045665195168 78.15138224949999 L 1195.045665195168 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1204.589193584668" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Claims Provider (CP)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1231.7947905084961" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com</text></g><path fill="none" stroke="none"/><g><path fill="#00a2ed" stroke="black" paint-order="fill stroke markers" d=" M 1531.7066334765484 45.694589846499994 L 1606.7715802701969 45.694589846499994 L 1606.7715802701969 78.15138224949999 L 1531.7066334765484 78.15138224949999 L 1531.7066334765484 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1541.2501618660483" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">SMTP Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1544.0923096931967" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">outlook.com</text></g><path fill="none" stroke="none"/><g><path fill="#00a2ed" stroke="black" paint-order="fill stroke markers" d=" M 1725.4764868188986 45.694589846499994 L 1797.4350951115705 45.694589846499994 L 1797.4350951115705 78.15138224949999 L 1725.4764868188986 78.15138224949999 L 1725.4764868188986 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1735.0200152083985" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">IMAP Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1736.3089937850586" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">outlook.com</text></g><path fill="none" stroke="none"/><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 1843.0346735997273 45.694589846499994 L 1918.1133075271648 45.694589846499994 L 1918.1133075271648 78.15138224949999 L 1843.0346735997273 78.15138224949999 L 1843.0346735997273 45.694589846499994 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1852.5782019892272" y="60.5596248495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AuthN Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1863.9833609858092" y="69.3555035495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com</text></g><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 2222.8511331082273 32.1489366485 A 5.013650858999999 5.013650858999999 0 1 1 2222.851130601402 32.143922998476604 M 2217.8374822492274 37.16258750749999 L 2217.8374822492274 47.893559521499995 M 2211.5044495852276 41.03277413549999 L 2224.170514913227 41.03277413549999 M 2217.8374822492274 47.893559521499995 L 2211.5044495852276 57.92086123949999 M 2217.8374822492274 47.893559521499995 L 2224.170514913227 57.92086123949999" stroke-miterlimit="10" stroke-width="1.495299379" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="2196.0634878034266" y="66.71673993949999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Bob (RqP)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="2148.4754674787196" y="75.51261863949999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bob@outlook.com, bob@bar.com</text></g><g><path fill="lightpink" stroke="black" paint-order="fill stroke markers" d=" M 78.50038110255468 1799.9886171679984 A 5.013650858999999 5.013650858999999 0 1 1 78.50037859572947 1799.983603517975 M 73.48673024355469 1805.0022680269983 L 73.48673024355469 1815.7332400409982 M 67.15369757955469 1808.8724546549984 L 79.81976290755469 1808.8724546549984 M 73.48673024355469 1815.7332400409982 L 67.15369757955469 1825.7605417589982 M 73.48673024355469 1815.7332400409982 L 79.81976290755469 1825.7605417589982" stroke-miterlimit="10" stroke-width="1.495299379" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="51.97918477236328" y="1782.7926743094984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Alice (RO)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="4.3979393500000015" y="1791.5885530094984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alice@gmail.com, alice@foo.com</text></g><path fill="none" stroke="none"/><g><path fill="lightpink" stroke="black" paint-order="fill stroke markers" d=" M 264.43191271960154 1773.9967956094983 L 338.47206398102344 1773.9967956094983 L 338.47206398102344 1806.4535880124984 L 264.43191271960154 1806.4535880124984 L 264.43191271960154 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="273.97544110910155" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AuthZ Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="284.8612977375195" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">foo.com</text></g><path fill="none" stroke="none"/><g><path fill="lightpink" stroke="black" paint-order="fill stroke markers" d=" M 473.9982526745039 1773.9967956094983 L 584.8362402396367 1773.9967956094983 L 584.8362402396367 1806.4535880124984 L 473.9982526745039 1806.4535880124984 L 473.9982526745039 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="483.5417810640039" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Resource Server (RS)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="512.8265558442773" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">foo.com</text></g><path fill="none" stroke="none"/><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 775.5966526732539 1773.9967956094983 L 839.2702115274492 1773.9967956094983 L 839.2702115274492 1806.4535880124984 L 775.5966526732539 1806.4535880124984 L 775.5966526732539 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="785.1401810627539" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">RqP Client</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="790.8428025227148" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com</text></g><path fill="none" stroke="none"/><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 1195.045665195168 1773.9967956094983 L 1301.7251749770978 1773.9967956094983 L 1301.7251749770978 1806.4535880124984 L 1195.045665195168 1806.4535880124984 L 1195.045665195168 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1204.589193584668" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Claims Provider (CP)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1231.7947905084961" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com</text></g><path fill="none" stroke="none"/><g><path fill="#00a2ed" stroke="black" paint-order="fill stroke markers" d=" M 1531.7066334765484 1773.9967956094983 L 1606.7715802701969 1773.9967956094983 L 1606.7715802701969 1806.4535880124984 L 1531.7066334765484 1806.4535880124984 L 1531.7066334765484 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1541.2501618660483" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">SMTP Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1544.0923096931967" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">outlook.com</text></g><path fill="none" stroke="none"/><g><path fill="#00a2ed" stroke="black" paint-order="fill stroke markers" d=" M 1725.4764868188986 1773.9967956094983 L 1797.4350951115705 1773.9967956094983 L 1797.4350951115705 1806.4535880124984 L 1725.4764868188986 1806.4535880124984 L 1725.4764868188986 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1735.0200152083985" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">IMAP Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1736.3089937850586" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">outlook.com</text></g><path fill="none" stroke="none"/><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 1843.0346735997273 1773.9967956094983 L 1918.1133075271648 1773.9967956094983 L 1918.1133075271648 1806.4535880124984 L 1843.0346735997273 1806.4535880124984 L 1843.0346735997273 1773.9967956094983 Z" stroke-miterlimit="10" stroke-width="1.407340592" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1852.5782019892272" y="1788.8618306124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">AuthN Server</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1863.9833609858092" y="1797.6577093124984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com</text></g><g><path fill="lightsteelblue" stroke="black" paint-order="fill stroke markers" d=" M 2222.8511331082273 1799.9886171679984 A 5.013650858999999 5.013650858999999 0 1 1 2222.851130601402 1799.983603517975 M 2217.8374822492274 1805.0022680269983 L 2217.8374822492274 1815.7332400409982 M 2211.5044495852276 1808.8724546549984 L 2224.170514913227 1808.8724546549984 M 2217.8374822492274 1815.7332400409982 L 2211.5044495852276 1825.7605417589982 M 2217.8374822492274 1815.7332400409982 L 2224.170514913227 1825.7605417589982" stroke-miterlimit="10" stroke-width="1.495299379" stroke-dasharray=""/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="2196.0634878034266" y="1782.7926743094984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Bob (RqP)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="2148.4754674787196" y="1791.5885530094984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bob@outlook.com, bob@bar.com</text></g></g><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 2217.8374822492274 138.40315134449997 L 2213.4395428992275 138.40315134449997 M 1893.767808613446 119.49201213949999 L 2205.5232520692275 119.49201213949999 L 2213.4395428992275 127.40830296949999 L 2213.4395428992275 157.3142905495 L 1893.767808613446 157.3142905495 L 1893.767808613446 119.49201213949999 M 2205.5232520692275 119.49201213949999 L 2205.5232520692275 127.40830296949999 L 2213.4395428992275 127.40830296949999" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1906.0820387934464" y="131.80624231949997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">If Bob uses an email provider (outlook) that does not support webfinger,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1906.0820387934464" y="140.60212101949998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">he must set up his mailbox to automatically forward emails sent</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1906.0820387934464" y="149.39799971949998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">from challenge@bar.com to response@bar.com</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 993.5511245985157 207.4507991395 L 1503.21971557375 207.4507991395 L 1503.21971557375 227.68132014949998 L 993.5511245985157 227.68132014949998 L 993.5511245985157 207.4507991395" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1005.8653547785157" y="219.76502931949997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Claims Provider can send email messages from addresses challenge@bar.com and retrieve from response@bar.com</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 533.8151858070703 254.06895624950002 L 1073.1353875636328 254.06895624950002 L 1081.0516783936328 261.9852470795 L 1081.0516783936328 274.2994772595 L 533.8151858070703 274.2994772595 L 533.8151858070703 254.06895624950002 M 1073.1353875636328 254.06895624950002 L 1073.1353875636328 261.9852470795 L 1081.0516783936328 261.9852470795" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="546.1294159870703" y="266.38318642950003" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">RqP Client is registered at bar.com AuthN server and pre-registered as a universal AEMS public client at foo.com AuthZ server</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 343.7307933766797 287.4932953095 L 707.1874087074609 287.4932953095 L 715.1036995374609 295.4095861395 L 715.1036995374609 334.1114524195 L 343.7307933766797 334.1114524195 L 343.7307933766797 287.4932953095 M 707.1874087074609 287.4932953095 L 707.1874087074609 295.4095861395 L 715.1036995374609 295.4095861395" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="356.04502355667967" y="299.8075254895" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">foo.com Admin has set up the Resource Server and registers it's resource set</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="356.04502355667967" y="308.6034041895" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">'Incoming' and 'Outgoing' with the foo.com AuthZ server with the associated scopes:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="356.04502355667967" y="317.3992828895" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">'Outgoing': query, view</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="356.04502355667967" y="326.1951615895" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">'Incoming': create</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1044.755592371953 347.3052704695 L 1444.0989569703124 347.3052704695 L 1452.0152478003124 355.22156129949997 L 1452.0152478003124 385.12754887949995 L 1044.755592371953 385.12754887949995 L 1044.755592371953 347.3052704695 M 1444.0989569703124 347.3052704695 L 1444.0989569703124 355.22156129949997 L 1452.0152478003124 355.22156129949997" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1057.0698225519532" y="359.61950064949997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Claims Provider:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1057.0698225519532" y="368.4153793495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. publishes its metadata on a URL https:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1227.6636488458985" y="368.4153793495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">//</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1232.8469679376954" y="368.4153793495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">bar.com/.well-known/claims-provider-configuration</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1057.0698225519532" y="377.2112580495" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. is registered at Bob's AuthN server and is assigned 'query-users', 'view-users' admin roles</text></g><g><g><rect fill="white" stroke="none" x="1480.721776053383" y="398.32136692949996" width="63.8273622428125" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1482.041157858383" y="406.23765775949994" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Initiate request</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 2217.8374822492274 409.7560092395 L 814.6753722300182 409.7560092395" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(807.4334321003515,409.7560092395) translate(-807.4334321003515,-409.7560092395)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 814.7633310170182 406.0910597811666 L 807.4334321003515 409.7560092395 L 814.7633310170182 413.4209586978333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="588.4726643218554" y="422.9498272895" width="159.90534991371095" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="588.4726643218554" y="431.7457059895" width="85.67631548988281" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="589.7920461268554" y="430.86611811949996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. Request Alice's 'Outgoing' resource</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="589.7920461268554" y="439.66199681949996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(scope=query, view)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 443.1803482995 L 536.659186586737 443.1803482995" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(529.4172464570703,443.1803482995) translate(-529.4172464570703,-443.1803482995)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 536.747145373737 439.51539884116664 L 529.4172464570703 443.1803482995 L 536.747145373737 446.84529775783335 Z"/></g></g><g><g><rect fill="white" stroke="none" x="608.5204167022265" y="456.3741663495" width="119.80984515296875" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="609.8397985072265" y="464.2904571795" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. 401 with permission ticket</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 529.4172464570703 467.8088086595 L 800.1914919706849 467.8088086595" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(807.4334321003515,467.8088086595) translate(-807.4334321003515,-467.8088086595)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 800.1035331836848 464.14385920116666 L 807.4334321003515 467.8088086595 L 800.1035331836848 471.47375811783337 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1226.018863218305" y="504.75149919949996" width="98.56188983070312" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="1226.018863218305" y="513.5473778994999" width="235.9696962271875" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1227.3382450233048" y="512.6677900294999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3. a) Get access_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1227.3382450233048" y="521.4636687294999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(grant_type=authorization_code, scope=claims-provider)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 524.9820202095 L 1873.3320504337792 524.9820202095" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1880.573990563446,524.9820202095) translate(-1880.573990563446,-524.9820202095)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1873.2440916467792 521.3170707511666 L 1880.573990563446 524.9820202095 L 1873.2440916467792 528.6469696678333 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1229.3962130718205" y="561.9247107494999" width="98.56188983070312" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="1229.3962130718205" y="570.7205894494999" width="229.21499652015626" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1230.7155948768204" y="569.8410015794999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3. b) Get access_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1230.7155948768204" y="578.6368802794999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(grant_type=client_credentials, scope=claims-provider)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 582.1552317594999 L 1873.3320504337792 582.1552317594999" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1880.573990563446,582.1552317594999) translate(-1880.573990563446,-582.1552317594999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1873.2440916467792 578.4902823011665 L 1880.573990563446 582.1552317594999 L 1873.2440916467792 585.8201812178332 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1231.3274111919377" y="608.5428678594999" width="225.3526002799219" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1232.6467929969376" y="616.4591586894999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">4. Return access_token "audience":["claims-provider"]</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1880.573990563446 619.9775101694999 L 814.6753722300182 619.9775101694999" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(807.4334321003515,619.9775101694999) translate(-807.4334321003515,-619.9775101694999)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 814.7633310170182 616.3125607111665 L 807.4334321003515 619.9775101694999 L 814.7633310170182 623.6424596278332 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 643.2865887244998 L 811.8313714503515 643.2865887244998 M 811.8313714503515 633.1713282194999 L 1060.0525589246874 633.1713282194999 L 1067.9688497546874 641.0876190494998 L 1067.9688497546874 653.4018492294998 L 811.8313714503515 653.4018492294998 L 811.8313714503515 633.1713282194999 M 1060.0525589246874 633.1713282194999 L 1060.0525589246874 641.0876190494998 L 1067.9688497546874 641.0876190494998" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="824.1456016303515" y="645.4855583994997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">ticket_challenge = Base64URL-Encode(SHA256(ticket))</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 700.4598002744998 L 811.8313714503515 700.4598002744998 M 811.8313714503515 690.3445397694999 L 1236.0711899061328 690.3445397694999 L 1243.9874807361327 698.2608305994999 L 1243.9874807361327 710.5750607794998 L 811.8313714503515 710.5750607794998 L 811.8313714503515 690.3445397694999 M 1236.0711899061328 690.3445397694999 L 1236.0711899061328 698.2608305994999 L 1243.9874807361327 698.2608305994999" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="824.1456016303516" y="702.6587699494997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Bob's email_address is in access_token "audience":["claims-provider"] returned in request 3. a) / 4.</text></g><g><g><rect fill="white" stroke="none" x="896.5677359386328" y="723.7688788294998" width="95.96113604652344" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="896.5677359386328" y="732.5647575294998" width="262.68338030921876" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="897.8871177436329" y="731.6851696594998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">5. a) Get claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="897.8871177436329" y="740.4810483594998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(access_token "audience":["claims-provider"], ticket_challenge)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 743.9993998394998 L 1241.143479956466 743.9993998394998" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1248.3854200861329,743.9993998394998) translate(-1248.3854200861329,-743.9993998394998)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1241.0555211694661 740.3344503811664 L 1248.3854200861329 743.9993998394998 L 1241.0555211694661 747.6643492978332 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 791.0573508844997 L 811.8313714503515 791.0573508844997 M 811.8313714503515 780.9420903794997 L 1016.2313308973437 780.9420903794997 L 1024.1476217273437 788.8583812094997 L 1024.1476217273437 801.1726113894997 L 811.8313714503515 801.1726113894997 L 811.8313714503515 780.9420903794997 M 1016.2313308973437 780.9420903794997 L 1016.2313308973437 788.8583812094997 L 1024.1476217273437 788.8583812094997" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="824.1456016303515" y="793.2563205594996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">The email_address is specified by RqP Client</text></g><g><g><rect fill="white" stroke="none" x="850.8266165538672" y="814.3664294394997" width="95.96113604652344" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="850.8266165538672" y="823.1623081394997" width="354.16561907875" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="852.1459983588672" y="822.2827202694997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">5. b) Get claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="852.1459983588672" y="831.0785989694997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(access_token "audience":["claims-provider"], Bob's email_address, ticket_challenge)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 834.5969504494997 L 1241.143479956466 834.5969504494997" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1248.3854200861329,834.5969504494997) translate(-1248.3854200861329,-834.5969504494997)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1241.0555211694661 830.9320009911663 L 1248.3854200861329 834.5969504494997 L 1241.0555211694661 838.261899907833 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 982.8404464979297 860.9845865494997 L 1506.0141028443359 860.9845865494997 L 1513.9303936743358 868.9008773794997 L 1513.9303936743358 881.2151075594996 L 982.8404464979297 881.2151075594996 L 982.8404464979297 860.9845865494997 M 1506.0141028443359 860.9845865494997 L 1506.0141028443359 868.9008773794997 L 1513.9303936743358 868.9008773794997" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="995.1546766779297" y="873.2988167294995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Claims Provider is assigned the 'query-users, view-users' admin roles, thus can query and view any user to get their claims</text></g><g><g><rect fill="white" stroke="none" x="1436.6543115568988" y="894.4089256094996" width="87.67602557289062" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="1436.6543115568988" y="903.2048043094997" width="255.65078753578126" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1437.9736933618988" y="902.3252164394996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">6. Get access_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1437.9736933618988" y="911.1210951394996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(grant_type=client_credentials, role=query-users, view-users)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1248.3854200861329 914.6394466194996 L 1873.3320504337792 914.6394466194996" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1880.573990563446,914.6394466194996) translate(-1880.573990563446,-914.6394466194996)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1873.2440916467792 910.9744971611663 L 1880.573990563446 914.6394466194996 L 1873.2440916467792 918.304396077833 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1442.9831232024067" y="927.8332646694996" width="242.99316424476564" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1444.3025050074066" y="935.7495554994996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">7. Return access_token "audience":["realm-management"]</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1880.573990563446 939.2679069794996 L 1255.6273602157996 939.2679069794996" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1248.3854200861329,939.2679069794996) translate(-1248.3854200861329,-939.2679069794996)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1255.7153190027996 935.6029575211662 L 1248.3854200861329 939.2679069794996 L 1255.7153190027996 942.9328564378329 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1002.7629318494922 976.2105975194996 L 1486.0916174927736 976.2105975194996 L 1494.0079083227736 984.1268883494996 L 1494.0079083227736 996.4411185294996 L 1002.7629318494922 996.4411185294996 L 1002.7629318494922 976.2105975194996 M 1486.0916174927736 976.2105975194996 L 1486.0916174927736 984.1268883494996 L 1494.0079083227736 984.1268883494996" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1015.0771620294922" y="988.5248276994995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Use Bob's email_address extracted from access_token "audience":["claims-provider"] from a request at step 5. a)</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1094.1495895643359 1033.3838090694994 L 1394.7049597779296 1033.3838090694994 L 1402.6212506079296 1041.3000998994994 L 1402.6212506079296 1053.6143300794995 L 1094.1495895643359 1053.6143300794995 L 1094.1495895643359 1033.3838090694994 M 1394.7049597779296 1033.3838090694994 L 1394.7049597779296 1041.3000998994994 L 1402.6212506079296 1041.3000998994994" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1106.463819744336" y="1045.6980392494995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Use Bob's email_address extracted from a request body at step 5. b)</text></g><g><g><rect fill="white" stroke="none" x="1414.6161340666645" y="1080.0019661794993" width="139.0444948111719" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="1414.6161340666645" y="1088.7978448794993" width="299.72714251625" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1415.9355158716644" y="1087.9182570094993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">8. Query/View Bob's user_claims</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1415.9355158716644" y="1096.7141357094993" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(access_token "audience":["realm-management"], Bob's email_address)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1248.3854200861329 1100.2324871894994 L 1873.3320504337792 1100.2324871894994" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1880.573990563446,1100.2324871894994) translate(-1880.573990563446,-1100.2324871894994)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1873.2440916467792 1096.567537731166 L 1880.573990563446 1100.2324871894994 L 1873.2440916467792 1103.8974366478326 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1504.980170626723" y="1113.4263052394992" width="118.99906939613281" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1506.299552431723" y="1121.3425960694992" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">9. Return Bob's user_claims</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1880.573990563446 1124.8609475494993 L 1255.6273602157996 1124.8609475494993" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1248.3854200861329,1124.8609475494993) translate(-1248.3854200861329,-1124.8609475494993)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1255.7153190027996 1121.195998091166 L 1248.3854200861329 1124.8609475494993 L 1255.7153190027996 1128.5258970078326 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1258.7938765477998" y="1161.8036380894991" width="300.03677386390626" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="1258.7938765477998" y="1170.5995167894991" width="220.4061433707422" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1260.1132583527997" y="1169.7199289194991" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">10. Send plain_message from challenge@bar.com to bob@outlook.com</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1260.1132583527997" y="1178.5158076194991" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(claims_provider_configuration_url, ticket_challenge)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1248.3854200861329 1182.0341590994992 L 1561.9971667437057 1182.0341590994992" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1569.2391068733725,1182.0341590994992) translate(-1569.2391068733725,-1182.0341590994992)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1561.9092079567058 1178.369209641166 L 1569.2391068733725 1182.0341590994992 L 1561.9092079567058 1185.6991085578325 Z"/></g></g><g><g><rect fill="white" stroke="none" x="1323.1123778954884" y="1195.227977149499" width="363.61645526039064" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="1323.1123778954884" y="1204.0238558494991" width="220.4061433707422" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1324.4317597004883" y="1203.144267979499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">11. Retrieve dkim_signed_message sent from bob@outlook.com to response@bar.com</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1324.4317597004883" y="1211.940146679499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(claims_provider_configuration_url, ticket_challenge)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1761.4557909652344 1215.4584981594992 L 1255.6273602157996 1215.4584981594992" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(1248.3854200861329,1215.4584981594992) translate(-1248.3854200861329,-1215.4584981594992)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1255.7153190027996 1211.793548701166 L 1248.3854200861329 1215.4584981594992 L 1255.7153190027996 1219.1234476178324 Z"/></g></g><g><g><rect fill="white" stroke="none" x="879.3484671398047" y="1241.846134259499" width="103.22596758949219" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="879.3484671398047" y="1250.642012959499" width="225.8080446158594" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="879.3484671398047" y="1259.437891659499" width="297.121917906875" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="880.6678489448047" y="1249.762425089499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">12. Return claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="880.6678489448047" y="1258.558303789499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(Bob's user_claims, dkim_signed_message - optional)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="880.6678489448047" y="1267.354182489499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">if the payload is large, consider using PCT (see UMA specs. for details)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1248.3854200861329 1270.872533969499 L 814.6753722300182 1270.872533969499" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(807.4334321003515,1270.872533969499) translate(-807.4334321003515,-1270.872533969499)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 814.7633310170182 1267.2075845111658 L 807.4334321003515 1270.872533969499 L 814.7633310170182 1274.5374834278323 Z"/></g></g><g><g><rect fill="white" stroke="none" x="475.48527452628906" y="1284.066352019499" width="98.06091326820312" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="475.48527452628906" y="1292.862230719499" width="157.91487139808595" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="476.80465633128904" y="1291.982642849499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">13. Call token endpoint</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="476.80465633128904" y="1300.778521549499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(ticket, pushed_claims=claims_token)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 1304.296873029499 L 308.69392847997915 1304.296873029499" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(301.4519883503125,1304.296873029499) translate(-301.4519883503125,-1304.296873029499)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 308.78188726697914 1300.6319235711658 L 301.4519883503125 1304.296873029499 L 308.78188726697914 1307.9618224878323 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 125.8064898597656 1317.490691079499 L 469.18119601085937 1317.490691079499 L 477.09748684085935 1325.4069819094989 L 477.09748684085935 1355.312969489499 L 125.8064898597656 1355.312969489499 L 125.8064898597656 1317.490691079499 M 469.18119601085937 1317.490691079499 L 469.18119601085937 1325.4069819094989 L 477.09748684085935 1325.4069819094989" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="138.12072003976562" y="1329.804921259499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">In addition to claims_token, pushed claims may also contain metadata such as:</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="138.12072003976562" y="1338.600799959499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. recipient_info (email address, fullname)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="138.12072003976562" y="1347.396678659499" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. file_info (filename, file size, file digest, mime type)</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 118.53946105117186 1416.0045325194988 L 476.4482248194531 1416.0045325194988 L 484.3645156494531 1423.9208233494987 L 484.3645156494531 1506.6020831294989 L 118.53946105117186 1506.6020831294989 L 118.53946105117186 1416.0045325194988 M 476.4482248194531 1416.0045325194988 L 476.4482248194531 1423.9208233494987 L 484.3645156494531 1423.9208233494987" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1428.3187626994988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. extract user_claims from claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1437.1146413994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. select email_address claim</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1445.9105200994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3. bootstrap discovery of Claims Provider config url via Webfinger, if it doesn't work</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1454.7063987994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">build well-known url using domain part of email_address</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1463.5022774994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">4. verify claims_token signature </text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1472.2981561994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">5. extract ticket_challenge claim from claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1481.0940348994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">6. compare ticket_challenge vs. Base64URL-Encode(SHA256(ticket))</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1489.8899135994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">7. evaluate user_claims</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="130.85369123117187" y="1498.6857922994989" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">8. evaluate other optional claims e.g. recipient_info, file_info</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 95.47642699355467 1543.5447736694987 L 499.5112588770703 1543.5447736694987 L 507.4275497070703 1551.4610644994987 L 507.4275497070703 1634.1423242794988 L 95.47642699355467 1634.1423242794988 L 95.47642699355467 1543.5447736694987 M 499.5112588770703 1543.5447736694987 L 499.5112588770703 1551.4610644994987 L 507.4275497070703 1551.4610644994987" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1555.8590038494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1. extract dkim_signed _message from claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1564.6548825494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2. verify DKIM signature of dkim_signed _message</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1573.4507612494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3. extract 'From:' part of dkim_signed_message e.g. Bob Sanders &lt;bob@outlook.com&gt;</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1582.2466399494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">4. extract claims_provider_configuration_url and ticket_challenge from dkim_signed_message</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1591.0425186494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">5. verify claims_token signature</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1599.8383973494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">6. compare ticket_challenge vs. Base64URL-Encode(SHA256(ticket))</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1608.6342760494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">7. extract user_claims from claims_token</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1617.4301547494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">8. evaluate user_claims</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="107.79065717355468" y="1626.2260334494988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">9. evaluate other optional claims e.g. recipient_info, file_info</text></g><g><g><rect fill="white" stroke="none" x="520.7208015648632" y="1673.7237784294985" width="67.4438173209375" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="522.0401833698633" y="1681.6400692594984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">14. Return RPT</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 301.4519883503125 1685.1584207394985 L 800.1914919706849 1685.1584207394985" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(807.4334321003515,1685.1584207394985) translate(-807.4334321003515,-1685.1584207394985)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 800.1035331836848 1681.4934712811653 L 807.4334321003515 1685.1584207394985 L 800.1035331836848 1688.8233701978318 Z"/></g></g><g><g><rect fill="white" stroke="none" x="574.7355198516406" y="1698.3522387894984" width="187.37963885414064" height="11.43464231"/></g><g><rect fill="white" stroke="none" x="574.7355198516406" y="1707.1481174894984" width="27.507705870742186" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="576.0549016566406" y="1706.2685296194984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">15. Get data from Alice's 'Outgoing' resource</text><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="576.0549016566406" y="1715.0644083194984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(RPT)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 807.4334321003515 1718.5827597994985 L 536.659186586737 1718.5827597994985" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(529.4172464570703,1718.5827597994985) translate(-529.4172464570703,-1718.5827597994985)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 536.747145373737 1714.9178103411653 L 529.4172464570703 1718.5827597994985 L 536.747145373737 1722.2477092578317 Z"/></g></g><g><g><rect fill="white" stroke="none" x="643.5100483550585" y="1731.7765778494984" width="49.830581847304686" height="11.43464231"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="7pt" font-style="normal" font-weight="normal" text-decoration="normal" x="644.8294301600586" y="1739.6928686794984" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">16. 200 OK</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 529.4172464570703 1743.2112201594985 L 800.1914919706849 1743.2112201594985" stroke-miterlimit="10" stroke-width="0.7329898916666666" stroke-dasharray=""/><g transform="translate(807.4334321003515,1743.2112201594985) translate(-807.4334321003515,-1743.2112201594985)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 800.1035331836848 1739.5462707011652 L 807.4334321003515 1743.2112201594985 L 800.1035331836848 1746.8761696178317 Z"/></g></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1889.3698692634462 95.7431396495 L 2248.6230576992275 95.7431396495 L 2248.6230576992275 170.5081085995 L 1889.3698692634462 170.5081085995 L 1889.3698692634462 95.7431396495 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1889.3698692634462 95.7431396495 L 1889.3698692634462 106.29819408949999 L 1918.5489221956727 106.29819408949999 L 1923.8264494156726 101.02066686949999 L 1923.8264494156726 95.7431396495 L 1889.3698692634462 95.7431396495" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1898.1657479634462" y="102.77984260949998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">opt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1932.6223281156726" y="102.77984260949998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Bob has to demonstrate control of his mailbox]</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 989.1531852485157 183.7019266495 L 1507.61765492375 183.7019266495 L 1507.61765492375 240.8751381995 L 989.1531852485157 240.8751381995 L 989.1531852485157 183.7019266495 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 989.1531852485157 183.7019266495 L 989.1531852485157 194.2569810895 L 1018.3322381807423 194.2569810895 L 1023.6097654007423 188.9794538695 L 1023.6097654007423 183.7019266495 L 989.1531852485157 183.7019266495" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="997.9490639485157" y="190.73862960949998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">opt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1032.4056441007422" y="190.73862960949998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Bob has to demonstrate control of his mailbox]</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 776.6478566503515 481.0026267095 L 1911.3595660134458 481.0026267095 L 1911.3595660134458 595.3490498094999 L 776.6478566503515 595.3490498094999 L 776.6478566503515 481.0026267095 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 776.6478566503515 481.0026267095 L 776.6478566503515 491.5576811495 L 802.9373679566015 491.5576811495 L 808.2148951766015 486.28015392950005 L 808.2148951766015 481.0026267095 L 776.6478566503515 481.0026267095" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="785.4437353503515" y="488.03932966950003" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="817.0107738766015" y="488.03932966950003" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[RqP Client uses Authorization Code Grant - Bob is involved]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 776.6478566503515 538.1758382594999 L 1911.3595660134458 538.1758382594999" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray="2.198969675"/></g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="817.0107738766015" y="545.2125412194999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[RqP Client uses Client Credential Grant - Bob is not involved]</text></g><g/><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 776.6478566503515 666.5956672794998 L 1279.1709955361328 666.5956672794998 L 1279.1709955361328 847.7907684994997 L 776.6478566503515 847.7907684994997 L 776.6478566503515 666.5956672794998 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 776.6478566503515 666.5956672794998 L 776.6478566503515 677.1507217194999 L 802.9373679566015 677.1507217194999 L 808.2148951766015 671.8731944994998 L 808.2148951766015 666.5956672794998 L 776.6478566503515 666.5956672794998" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="785.4437353503515" y="673.6323702394999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="817.0107738766015" y="673.6323702394999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Get Claims  - Bob was involved at step  3. a)]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 776.6478566503515 757.1932178894997 L 1279.1709955361328 757.1932178894997" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray="2.198969675"/></g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="817.0107738766015" y="764.2299208494998" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Get Claims - Bob was not involved at step  3. b)]</text></g><g/><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 998.3649924994922 952.4617250294996 L 1498.4058476727735 952.4617250294996 L 1498.4058476727735 1066.8081481294994 L 998.3649924994922 1066.8081481294994 L 998.3649924994922 952.4617250294996 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 998.3649924994922 952.4617250294996 L 998.3649924994922 963.0167794694996 L 1024.6545038057423 963.0167794694996 L 1029.9320310257422 957.7392522494996 L 1029.9320310257422 952.4617250294996 L 998.3649924994922 952.4617250294996" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1007.1608711994922" y="959.4984279894996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1038.7279097257422" y="959.4984279894996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Prepare email_address - Bob was involved at step  3. a)]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 998.3649924994922 1009.6349365794995 L 1498.4058476727735 1009.6349365794995" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray="2.198969675"/></g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1038.7279097257422" y="1016.6716395394996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Prepare email_address - Bob was not involved at step  3. b)]</text></g><g/><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1217.599844636133 1138.0547655994992 L 1792.2413664152343 1138.0547655994992 L 1792.2413664152343 1228.652316209499 L 1217.599844636133 1228.652316209499 L 1217.599844636133 1138.0547655994992 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1217.599844636133 1138.0547655994992 L 1217.599844636133 1148.6098200394993 L 1246.7788975683595 1148.6098200394993 L 1252.0564247883594 1143.3322928194991 L 1252.0564247883594 1138.0547655994992 L 1217.599844636133 1138.0547655994992" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1226.395723336133" y="1145.0914685594992" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">opt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="1260.8523034883594" y="1145.0914685594992" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Bob has to demonstrate control of his mailbox]</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 82.28260894355466 1368.5067875394989 L 520.6213677570703 1368.5067875394989 L 520.6213677570703 1660.5299603794986 L 82.28260894355466 1660.5299603794986 L 82.28260894355466 1368.5067875394989 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 82.28260894355466 1368.5067875394989 L 82.28260894355466 1379.061841979499 L 178.55446583085936 1379.061841979499 L 183.83199305085935 1373.7843147594988 L 183.83199305085935 1368.5067875394989 L 82.28260894355466 1368.5067875394989" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="91.07848764355467" y="1375.5434904994988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Authorization process</text></g><g><g/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 91.07848764355467 1392.2556600294988 L 511.8254890570703 1392.2556600294988 L 511.8254890570703 1647.3361423294987 L 91.07848764355467 1647.3361423294987 L 91.07848764355467 1392.2556600294988 Z" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 91.07848764355467 1392.2556600294988 L 91.07848764355467 1402.8107144694989 L 117.36799894980467 1402.8107144694989 L 122.64552616980467 1397.5331872494987 L 122.64552616980467 1392.2556600294988 L 91.07848764355467 1392.2556600294988" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray=""/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="99.87436634355467" y="1399.2923629894988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">alt</text><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="131.44140486980467" y="1399.2923629894988" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Domain part of email_address or Webfinger is used to locate Claims Provider configuration url]</text><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 91.07848764355467 1519.7959011794987 L 511.8254890570703 1519.7959011794987" stroke-miterlimit="10" stroke-width="1.2565541" stroke-dasharray="2.198969675"/></g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="5.6000000000000005pt" font-style="normal" font-weight="bold" text-decoration="normal" x="131.44140486980467" y="1526.8326041394987" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">[Bob has to demonstrate control of his mailbox]</text></g><g/></g></g></svg>