{
  "allowRemoteResourceManagement": true,
  "policyEnforcementMode": "ENFORCING",
  "resources": [
    {
      "name": "Default Resource",
      "type": "urn:email-storage:resources:default",
      "ownerManagedAccess": true,
      "attributes": {},
      "_id": "46309bbd-c24d-41b0-ac94-2d0f08dc0371",
      "uris": [
        "/*"
      ]
    },
    {
      "name": "message-0e85858e-c0e3-4d47-8e77-cfe6d5d32aec",
      "type": "http://email.com/message",
      "owner": {
        "name": "igor.zboran@gmail.com"
      },
      "ownerManagedAccess": true,
      "attributes": {
        "client_id": [
          "email-rp"
        ],
        "tac": [
          "53d7057e-4359-43c2-babd-1e46c5f66a0c"
        ]
      },
      "_id": "2ad577c7-0f6f-4d28-926a-45457a9d63fc",
      "uris": [
        "/message/*"
      ],
      "scopes": [
        {
          "name": "message:delete"
        },
        {
          "name": "message:view"
        }
      ]
    },
    {
      "name": "message-f8869edb-12cb-4d38-8fe8-44ec4774502e",
      "type": "http://email.com/message",
      "owner": {
        "name": "igor.zboran@gmail.com"
      },
      "ownerManagedAccess": true,
      "attributes": {
        "client_id": [
          "email-rp"
        ],
        "tac": [
          "3ac2b203-748f-4aa7-b117-7e463d8e465d"
        ]
      },
      "_id": "233b36cb-6d65-44b7-8f92-f014c2ef0aed",
      "uris": [
        "/message/*"
      ],
      "scopes": [
        {
          "name": "message:delete"
        },
        {
          "name": "message:view"
        }
      ]
    },
    {
      "name": "Email Resource",
      "type": "http://email.com/message",
      "ownerManagedAccess": true,
      "displayName": "Email Resource",
      "attributes": {},
      "_id": "251bf0fd-4019-42a5-9699-6e85048e9024",
      "uris": [
        "/mailbox/*"
      ]
    }
  ],
  "policies": [
    {
      "id": "81b4bae2-1586-4434-aca5-796e2f531d3d",
      "name": "Default Policy",
      "description": "A policy that grants access only for users within this realm",
      "type": "js",
      "logic": "POSITIVE",
      "decisionStrategy": "AFFIRMATIVE",
      "config": {
        "code": "// by default, grants any permission associated with this policy\n$evaluation.grant();\n"
      }
    },
    {
      "id": "a4d29953-5ee7-48f6-9691-d628772d32ce",
      "name": "Email Policy",
      "type": "role",
      "logic": "POSITIVE",
      "decisionStrategy": "UNANIMOUS",
      "config": {
        "roles": "[{\"id\":\"user\",\"required\":false}]"
      }
    },
    {
      "id": "1ce5b1e2-403f-4036-a8dd-8ba1aa9bb6df",
      "name": "aems-grant",
      "description": "A policy that grants access to recipients",
      "type": "js",
      "logic": "POSITIVE",
      "decisionStrategy": "UNANIMOUS",
      "config": {
        "code": "var context = $evaluation.context;\nvar identity = context.getIdentity();\n// var client = context.getClient();\n\nvar accessToken = identity.getAccessToken();\n\nvar identityAttributes = identity.getAttributes();\nvar username = identityAttributes.getValue('preferred_username').asString(0);\n\nvar contextAttributes = context.attributes;\n// var ticket = $evaluation.getPermission().getTicket();\nvar resource = $evaluation.getPermission().getResource();\nvar resourceAttributes = resource.getAttributes();\nvar contextTac = contextAttributes.getValue('tac').asString(0);\nvar resourceTac = resourceAttributes.tac[0];\nvar contextClient = contextAttributes.getValue('kc.client.id').asString(0);\nvar resourceClient = resourceAttributes.client_id[0];\n// var contextJti = contextAttributes.getValue('jti').asString(0);\n// var contextClientHost = $evaluation.getPermission().getClient().getRepresentation().getBaseUrl();\n\nfunction httpGet(theUrl){\n    var con = new java.net.URL(theUrl).openConnection();\n    con.requestMethod = \"GET\";\n\n    return asResponse(con);\n}\n\nfunction asResponse(con){\n    var d = read(con.inputStream);\n\n    return {data : d, statusCode : con.responseCode};\n}\n\nfunction read(inputStream){\n    var inReader = new java.io.BufferedReader(new java.io.InputStreamReader(inputStream));\n    var inputLine;\n    var response = new java.lang.StringBuffer();\n\n    while ((inputLine = inReader.readLine()) !== null) {\n           response.append(inputLine);\n    }\n    inReader.close();\n    return response.toString();\n}\n\nvar response = httpGet(\"https://jsonplaceholder.typicode.com/todos/1\").data;\nprint(response);\n\nprint('username=' + username);\n// print('accessToken=' + accessToken.getOtherClaims());\n\n// var permission = $evaluation.getPermission();\n// var path = permission.getClaims().get('accessed-endpoint').toArray()[0];\n// print(permission.getClaims());\n\n// print('accessToken=' + $evaluation.getPermission().getId());\n\n\nprint(identityAttributes.toMap());\nprint(contextAttributes.toMap());\n// print(resourceAttributes.toMap());\n\n/*print('contextAttributes=' + contextAttributes);\nprint('resourceAttributes=' + resourceAttributes);\nprint('contextClient=' + contextClient);\n// print('contextClientHost=' + contextClientHost);\nprint('resourceClient=' + resourceClient);\nprint('contextTac=' + contextTac);\nprint('resourceTac=' + resourceTac);*/\n\nif ((contextClient == resourceClient) && (contextTac === resourceTac)) {\n    $evaluation.grant();\n} else {\n    $evaluation.deny();\n}"
      }
    },
    {
      "id": "6bbfba81-6c9c-46b0-bf60-b3d9d44de935",
      "name": "rp-client-policy",
      "description": "Requesting Party has access",
      "type": "client",
      "logic": "POSITIVE",
      "decisionStrategy": "UNANIMOUS",
      "config": {
        "clients": "[\"email-rp\"]"
      }
    },
    {
      "id": "24398ae8-cb29-451f-9478-5c073514ff7c",
      "name": "Default Permission",
      "description": "A permission that applies to the default resource type",
      "type": "resource",
      "logic": "POSITIVE",
      "decisionStrategy": "UNANIMOUS",
      "config": {
        "defaultResourceType": "urn:email-storage:resources:default",
        "applyPolicies": "[\"Default Policy\"]"
      }
    },
    {
      "id": "744a8577-7e86-43dd-b086-fffaf5195f98",
      "name": "email-resource-permission",
      "type": "resource",
      "logic": "POSITIVE",
      "decisionStrategy": "UNANIMOUS",
      "config": {
        "defaultResourceType": "http://email.com/message",
        "applyPolicies": "[\"rp-client-policy\"]"
      }
    }
  ],
  "scopes": [
    {
      "id": "5cf44134-a149-41a0-8707-84f16bf30f46",
      "name": "message:delete"
    },
    {
      "id": "be680bde-aa0f-45ba-90c5-ffefa684d1b8",
      "name": "message:view"
    }
  ],
  "decisionStrategy": "UNANIMOUS"
}